<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è½¦è´·çœŸé¢ç›®ï¼šè´­è½¦è®¡ç®—å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .apr-value { font-family: 'JetBrains Mono', monospace; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-20">

    <header class="bg-blue-600 p-6 text-white shadow-lg mb-4">
        <h1 class="text-xl font-bold flex items-center">
            <span class="mr-2">âš–ï¸</span> è½¦è´·çœŸé¢ç›®
        </h1>
        <p class="text-blue-100 text-xs mt-1">åˆ«å¬é”€å”®å¹ï¼Œç®—ç®— IRR æ‰çŸ¥é“æ˜¯ä¸æ˜¯é«˜åˆ©è´·</p>
    </header>

    <main class="max-w-md mx-auto px-4 space-y-4">
        
        <div class="glass-card p-5 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider">ç¬¬ä¸€æ­¥ï¼šåŸºç¡€è´¦å•</h2>
            
            <div class="grid grid-cols-1 gap-4">
                <div class="flex flex-col">
                    <label class="text-xs text-slate-400 mb-1">è£¸è½¦ä»·æ ¼ (å…ƒ)</label>
                    <input type="number" id="carPrice" placeholder="0" class="bg-slate-100 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all font-bold">
                </div>
                
                <div class="flex flex-col">
                    <label class="text-xs text-slate-400 mb-1">æ‚è´¹ (è´­ç½®ç¨+ä¿é™©+ä¸Šç‰Œç­‰)</label>
                    <input type="number" id="otherFees" placeholder="0" class="bg-slate-100 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all font-bold">
                </div>

                <div class="flex flex-col">
                    <label class="text-xs text-slate-400 mb-1">è´·æ¬¾æœ¬é‡‘ (å®é™…æ¬ é“¶è¡Œçš„é’±)</label>
                    <input type="number" id="loanAmount" placeholder="0" class="bg-slate-100 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all font-bold text-blue-600">
                </div>

                <div class="flex flex-col">
                    <label class="text-xs text-slate-400 mb-1">åˆ†æœŸå¹´é™</label>
                    <div class="flex gap-2">
                        <button onclick="setTerm(24, this)" class="term-btn flex-1 py-2 rounded-lg border-2 border-slate-200 text-sm font-bold active-term">2å¹´</button>
                        <button onclick="setTerm(36, this)" class="term-btn flex-1 py-2 rounded-lg border-2 border-slate-200 text-sm font-bold bg-blue-50 border-blue-500 text-blue-600">3å¹´</button>
                        <button onclick="setTerm(60, this)" class="term-btn flex-1 py-2 rounded-lg border-2 border-slate-200 text-sm font-bold">5å¹´</button>
                        <input type="number" id="customTerm" placeholder="æœˆæ•°" class="w-20 p-2 bg-slate-100 rounded-lg text-xs font-bold text-center">
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card p-5 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider">ç¬¬äºŒæ­¥ï¼šè¿˜æ¬¾è¯¦æƒ…</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 mb-1">è¿˜æ¬¾æ¨¡å¼</label>
                    <select id="loanMode" class="w-full bg-slate-100 p-3 rounded-xl outline-none appearance-none font-bold text-sm">
                        <option value="flat">å¹³æ¯æ¨¡å¼ (é”€å”®å£ä¸­çš„æœˆè´¹ç‡)</option>
                        <option value="pi">ç­‰é¢æœ¬æ¯ (é“¶è¡Œæ ‡å‡†æ–¹æ¡ˆ)</option>
                        <option value="ep">ç­‰é¢æœ¬é‡‘ (æ¯æœŸæœ¬é‡‘å›ºå®š)</option>
                    </select>
                </div>

                <div class="flex flex-col">
                    <label class="text-xs text-slate-400 mb-1">é”€å”®ç»™ä½ çš„ã€Œæœˆä¾›é‡‘é¢ã€ (å…ƒ)</label>
                    <input type="number" id="monthlyPay" placeholder="å¿…é¡»å¡«å†™" class="bg-orange-50 border-2 border-orange-200 p-4 rounded-xl outline-none focus:ring-2 focus:ring-orange-500 transition-all font-bold text-xl text-orange-700">
                </div>

                <div class="flex flex-col">
                    <label class="text-xs text-slate-400 mb-1">éšè—æ‰‹ç»­è´¹/é‡‘èè´¹ (è‹¥æœ‰ï¼Œä¸”æœªåŒ…å«åœ¨è´·æ¬¾é‡Œ)</label>
                    <input type="number" id="extraFee" value="0" class="bg-slate-100 p-3 rounded-xl outline-none font-bold">
                </div>
            </div>
        </div>

        <div id="resultCard" class="hidden glass-card p-6 rounded-3xl shadow-xl border-4 border-slate-900">
            <h2 class="text-center text-sm font-black text-slate-900 mb-2 italic">â€”â€” çœŸå®ä»£ä»·åˆ†æ â€”â€”</h2>
            
            <div class="text-center py-6">
                <p class="text-xs text-slate-500 font-bold mb-1">çœŸå®å¹´åŒ–åˆ©ç‡ (APR/IRR)</p>
                <div id="aprValue" class="apr-value text-6xl font-black text-red-600">--%</div>
            </div>

            <div id="alertBox" class="p-4 rounded-xl mb-6 text-sm font-bold flex items-start gap-3">
                <span id="alertIcon" class="text-xl"></span>
                <span id="alertMsg"></span>
            </div>

            <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="bg-slate-50 p-3 rounded-lg">
                    <p class="text-slate-400 text-xs">æ€»åˆ©æ¯æ”¯å‡º</p>
                    <p id="totalInterest" class="font-bold text-lg text-slate-800">Â¥0</p>
                </div>
                <div class="bg-slate-50 p-3 rounded-lg">
                    <p class="text-slate-400 text-xs">æœ€ç»ˆè½åœ°æ€»ä»·</p>
                    <p id="totalFinal" class="font-bold text-lg text-slate-800">Â¥0</p>
                </div>
            </div>

            <div class="mt-6 border-t pt-4 border-dashed border-slate-200">
                <h3 class="text-xs font-bold text-slate-400 mb-3">æå‰è¿˜æ¬¾æ¨¡æ‹Ÿå™¨</h3>
                <div class="flex items-center gap-2">
                    <span class="text-xs">å¦‚æœç¬¬</span>
                    <input type="number" id="earlyMonth" value="12" class="w-16 bg-slate-100 p-1 rounded font-bold text-center">
                    <span class="text-xs">æœŸæå‰è¿˜æ¸…ï¼š</span>
                </div>
                <div id="earlyResult" class="mt-2 text-xs text-blue-600 bg-blue-50 p-2 rounded leading-relaxed">
                    è¾“å…¥æ•°æ®ä»¥è®¡ç®—...
                </div>
            </div>
        </div>

        <button onclick="calculate()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all">
            å¼€å§‹æ‹†ç©¿è°è¨€
        </button>

    </main>

    <div id="tipsModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-6 max-w-xs relative">
            <h3 class="text-lg font-black mb-4 flex items-center"><span class="mr-2">ğŸ’¡</span> 4S åº—å®æˆ˜åæ€ Tips</h3>
            <ul class="text-sm space-y-3 text-slate-600 font-medium">
                <li>â€¢ é”€å”®è¯´â€œå¹³æ¯/æœˆè´¹ç‡ 0.3%â€ï¼Œå®é™…å¹´åŒ–é€šå¸¸åœ¨ <b>6.6%</b> å·¦å³ã€‚</li>
                <li>â€¢ æ‰€è°“â€œä¸¤å¹´å…æ¯â€ï¼Œå¦‚æœæ”¶äº†ä½  3000 å…ƒâ€œé‡‘èæœåŠ¡è´¹â€ï¼Œå…¶å®ç›¸å½“äºå˜ç›¸é«˜åˆ©è´·ã€‚</li>
                <li>â€¢ è°ˆä»·æ ¼æ—¶å…ˆç£¨<b>è£¸è½¦ä»·</b>ï¼Œæœ€åå†è°ˆåˆ†æœŸã€‚</li>
                <li>â€¢ å¿…é¡»è¦æ±‚æŸ¥çœ‹é“¶è¡Œçš„<b>æ­£å¼è¿˜æ¬¾è®¡åˆ’è¡¨</b>ã€‚</li>
            </ul>
            <button onclick="toggleTips()" class="mt-6 w-full bg-blue-600 text-white py-3 rounded-xl font-bold">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <button onclick="toggleTips()" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center text-xl z-40">
        ğŸ’¡
    </button>

    <script>
        let currentTerm = 36;

        // è®¾ç½®å¿«æ·å¹´é™
        function setTerm(val, btn) {
            currentTerm = val;
            document.querySelectorAll('.term-btn').forEach(b => {
                b.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-600');
            });
            btn.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-600');
            document.getElementById('customTerm').value = '';
        }

        function toggleTips() {
            const m = document.getElementById('tipsModal');
            m.classList.toggle('hidden');
        }

        // --- æ ¸å¿ƒç®—æ³•åŒº ---

        /**
         * ç‰›é¡¿è¿­ä»£æ³•åæ¨ IRR (æœˆåˆ©ç‡)
         * å…¬å¼: P * r * (1+r)^n / ((1+r)^n - 1) - M = 0
         * P: æœ¬é‡‘, M: æœˆä¾›, n: æœŸæ•°
         */
        function deriveIRR(P, M, n) {
            if (M * n <= P) return 0; // æ— åˆ©æ¯æˆ–è´Ÿåˆ©æ¯

            let r = 0.01; // åˆå§‹çŒœæµ‹æœˆåˆ©ç‡ 1%
            const precision = 0.0000001;
            const maxIteration = 100;

            for (let i = 0; i < maxIteration; i++) {
                let x = Math.pow(1 + r, n);
                let f = P * r * x / (x - 1) - M; // å‡½æ•° f(r)
                // å¯¼æ•° f'(r)
                let df = P * (x * (x - 1) + r * n * Math.pow(1 + r, n - 1) * (x - 1) - r * x * n * Math.pow(1 + r, n - 1)) / Math.pow(x - 1, 2);
                
                let nextR = r - f / df;
                if (Math.abs(nextR - r) < precision) return nextR;
                r = nextR;
            }
            return r;
        }

        function calculate() {
            // è·å–è¾“å…¥å¹¶è½¬ä¸ºâ€œåˆ†â€è¿›è¡Œè®¡ç®—ä»¥é˜²æµ®ç‚¹è¯¯å·®
            const toCents = (val) => Math.round((parseFloat(val) || 0) * 100);
            
            const p_car = toCents(document.getElementById('carPrice').value);
            const p_fees = toCents(document.getElementById('otherFees').value);
            const P = toCents(document.getElementById('loanAmount').value); // è´·æ¬¾æœ¬é‡‘
            const M = toCents(document.getElementById('monthlyPay').value); // é”€å”®ç»™çš„æœˆä¾›
            const extra = toCents(document.getElementById('extraFee').value); // é™„åŠ æ‰‹ç»­è´¹
            
            let n = parseInt(document.getElementById('customTerm').value) || currentTerm;

            if (P <= 0 || M <= 0 || n <= 0) {
                alert("è¯·è¾“å…¥æ­£ç¡®çš„è´·æ¬¾é‡‘é¢ã€æœˆä¾›å’ŒæœŸé™ï¼");
                return;
            }

            // 1. è®¡ç®— IRR (æœˆåˆ©ç‡)
            // æ³¨æ„ï¼šå¦‚æœæœ‰å‰æœŸä¸€æ¬¡æ€§ä»˜æ¸…çš„ extra æ‰‹ç»­è´¹ï¼Œç­‰æ•ˆäºæœ¬é‡‘å‡å°‘
            const effectiveP = P - extra; 
            const monthlyIRR = deriveIRR(effectiveP, M, n);
            const annualAPR = monthlyIRR * 12 * 100;

            // 2. æ€»æ”¯å‡ºè®¡ç®—
            const totalPaidLoan = M * n;
            const totalInterest = totalPaidLoan - P;
            const totalLanding = p_car + p_fees + totalInterest + extra;

            // 3. UI æ›´æ–°
            document.getElementById('resultCard').classList.remove('hidden');
            const aprEl = document.getElementById('aprValue');
            aprEl.innerText = annualAPR.toFixed(2) + "%";

            // 4. åæ€æç¤ºé€»è¾‘
            const alertBox = document.getElementById('alertBox');
            const alertMsg = document.getElementById('alertMsg');
            const alertIcon = document.getElementById('alertIcon');

            if (annualAPR > 9) {
                alertBox.className = "p-4 rounded-xl mb-6 text-sm font-bold flex items-start gap-3 bg-red-100 text-red-700";
                alertIcon.innerText = "âŒ";
                alertMsg.innerText = "è¿™æ˜¯å½»å¤´å½»å°¾çš„é«˜åˆ©è´·ï¼å®é™…åˆ©ç‡å·²ç»ä¸Šå¤©äº†ï¼Œé”€å”®åœ¨æŠŠä½ å½“çŒªå®°ã€‚å»ºè®®æ¢ä¸€å®¶åº—æˆ–ç›´æ¥å…¨æ¬¾ã€‚";
                aprEl.className = "apr-value text-6xl font-black text-red-600";
            } else if (annualAPR > 6) {
                alertBox.className = "p-4 rounded-xl mb-6 text-sm font-bold flex items-start gap-3 bg-orange-100 text-orange-700";
                alertIcon.innerText = "âš ï¸";
                alertMsg.innerText = "ä»·æ ¼æ˜æ˜¾åé«˜ã€‚ç›®å‰ä¸»æµé“¶è¡Œè½¦è´· APR åº”è¯¥åœ¨ 3.5%-5% ä¹‹é—´ï¼Œä½ è¿˜æœ‰å¾ˆå¤§çš„ç ä»·ç©ºé—´ã€‚";
                aprEl.className = "apr-value text-6xl font-black text-orange-500";
            } else {
                alertBox.className = "p-4 rounded-xl mb-6 text-sm font-bold flex items-start gap-3 bg-green-100 text-green-700";
                alertIcon.innerText = "âœ…";
                alertMsg.innerText = "åˆ©ç‡å¤„äºæ­£å¸¸é“¶è¡Œæ°´å¹³ã€‚è¯·ç¡®è®¤æ˜¯å¦æœ‰éšè—çš„å¼ºåˆ¶è£…æ½¢æˆ–æ†ç»‘æ¶ˆè´¹ã€‚";
                aprEl.className = "apr-value text-6xl font-black text-green-600";
            }

            document.getElementById('totalInterest').innerText = "Â¥" + (totalInterest / 100).toLocaleString();
            document.getElementById('totalFinal').innerText = "Â¥" + (totalLanding / 100).toLocaleString();

            // 5. æå‰è¿˜æ¬¾é€»è¾‘ (ç®€åŒ–ç‰ˆï¼šå‡è®¾æŒ‰å‰©ä½™æœ¬é‡‘è®¡ç®—)
            const earlyM = parseInt(document.getElementById('earlyMonth').value) || 12;
            if (earlyM < n) {
                // ç­‰é¢æœ¬æ¯ä¸‹çš„å‰©ä½™æœ¬é‡‘è®¡ç®—
                // Bal = P * [(1+r)^n - (1+r)^m] / [(1+r)^n - 1]
                const r = monthlyIRR;
                const powN = Math.pow(1 + r, n);
                const powM = Math.pow(1 + r, earlyM);
                const remainingPrincipal = P * (powN - powM) / (powN - 1);
                
                const interestSaved = totalInterest - (M * earlyM - (P - remainingPrincipal));
                
                document.getElementById('earlyResult').innerHTML = `
                    å·²è¿˜æœ¬æ¯: <b>Â¥${(M * earlyM / 100).toFixed(2)}</b><br>
                    å‰©ä½™å¾…è¿˜æœ¬é‡‘: <b class="text-red-600">Â¥${(remainingPrincipal / 100).toFixed(2)}</b><br>
                    è‹¥æ— è¿çº¦é‡‘ï¼Œå¯èŠ‚çœåˆ©æ¯: <b>Â¥${(interestSaved / 100).toFixed(2)}</b>
                `;
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°ç»“æœ
            window.scrollTo({ top: document.getElementById('resultCard').offsetTop - 20, behavior: 'smooth' });
        }
    </script>
</body>
</html>